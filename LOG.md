## 2018.10.17

尝试复杂材质的重要性采样但失败了。

## 2018.10.18

总结了一番项目存在的问题并决定重构。

## 2018.10.19

重构完成了大体框架，对之前注意到的问题有以下对策：

```
系统地做一套Common Distribution Transformer，这个做进Utils好了
    已经做进Utils了，这东西零零散散地写容易出问题，集中精力来搞还真不困难
缺乏一致的处理无限光源、无实体光源、有实体光源的方法
    分了AreaLe和Le用于处理有实体和无实体光源，无限光源当成无实体光源处理
缺乏光源采样策略的指导性原则
    没啥好指导的，接口统一就行，各自想办法
BxDF的局部坐标系各自为政
    BSDF记录local coordinate system
wi和wo混乱不堪，面对非对称BSDF太烧脑
    统一命名，wi和wo表示radiance的传播方向而不是importance的
缺乏GeometryTemplate的接口规范
    统一做成Geometry基类，慢点没关系，不再用模板了，SFINAE写得心累
几何参数坐标和着色参数坐标的框架不明朗
    分离了geoLocal和shdLocal，前者由求交过程给出，后者由Material在SurfacePoint的基础上给出
交点的几何信息和着色信息应该分开存储和传递，现在的Intersection简直是混沌恶
    分开做了SurfacePoint和ShadingPoint
没有引入时间参数，没法做动态模糊这种炫酷效果
    暂时不考虑
```

约定world space中wi、wo以及r.dir都是单位向量，并且在用到的地方随手assert之。

另外，仍然没有加participating medium的接口，要把这东西和其他组件的交互想清楚太烧脑了。

## 2018.10.21

完成了用MIS计算直接光照的PathTracer。其实公式推导到完成代码一条龙只花了小半天，但是和重构前的PathTracer相比，画出来的东西总是特别暗。调了大半天，什么手段都试过了，最后发现是因为测试代码里最后输出图像的时候$\gamma$校正的1/2.2写成了2.2，尼玛……

## 2018.10.22

刚开始写材质系统，完成了BxDFAggregate，DiffuseBRDF和PerfectSpecularReflection

## 2018.10.30

居然好几天忘了写日志。这几天主要完成了Cube类型的Geometry Object，三角形网格的BVH树，OBJ文件解析以及Torrance-Sparrow反射模型，添加了塑料、金属之类的材质。哦对，还支持了纹理，包括nearest和bilinear采样，Mipmap就先不管了。

## 2018.10.31

今天完成了Global BVH和Utils中的Config组件。下一步目标是写介质，想想牛奶玉石还有丁达尔效应就让人开心。

先稍微整理一下思路。任何光线的传播过程都要把介质考虑进来，因为必须跟踪任何light-carrying ray所处的介质。任何可以产生ray的东西都要指定它产生的ray所处的介质是什么，ray和表面发生intersection的时候也要做介质切换。目前，应该是要让entity指定in和out两种介质，scene指定虚空中的介质。Camera不指定介质，因为camera出来的ray的介质要么由首个交点指定，要么是虚空介质。

传播过程也有两类：light-surface传播，以及surface-surface传播，这两个过程都由integrator完成。

## 2018.11.2

本来是想写个GPU加速的BVH的，但是装了CUDA过后只要写的cu代码一有什么问题，直接死机，我觉得这样下去我是调不出来的，所以暂且放下吧。

尽管如此，还是死怼了一番性能，大幅优化了BVH求交速度——其实就是消除了关键路径上的一个分支，效果好得出乎我的意料了——即使是在profiler的帮助下，你永远也想不到代码的性能瓶颈在哪。

Wait，说好的介质渲染呢？我白天推导了一番带介质的path tracer的估计量，只是还没动手写代码。

## 2018.11.3

今天比较失败。想用SSE/AVX加速BVH，然后喜闻乐见地负优化了。唯一的“进度”是画了张最高精度的Stanford Bunny（之前画的都是低模）。

## 2018.11.4

发现一个[非常良心的网站](http://threedscans.com/)，上面有一大堆扫描出来的精模，LICENSE是你爱怎么用就怎么用的那种。我立刻在上面下了个人像，简直是素材宝库啊！

这上面的模型动不动就是几十上百万面，我跑的时候果不其然BVH遍历爆栈了。我先是把BVH用`std::stack`改成非递归版本，然后嫌弃它动态内存分配太慢，自己写分配又太麻烦，干脆开了个`thread_local`的静态数组。但是我把数组开到1024依然会溢出，这时我开始怀疑是不是自己的SAH写炸了，不然BVH不应该这么深才对。于是我写了个简单粗暴的BVH划分策略——按图元数量二等分，结果效率瞬间上天，这说明我之前的SAH肯定是有问题的。至于问题是什么，暂时不想查了。

之前觉得跑得太慢，使劲怼代码上的常数；现在发现算法有问题，改了之后，啧啧，真快。

## 2018.11.5

把VolumetricPathTracer写了大半，真是在考试的边缘疯狂作死。

## 2018.11.6

VolumetricPathTracer done！开心！刚做出来的时候噪点多得可怕，检查了一番发现是采样介质自发光和表面自发光时没有截断计算透射比用的距离，改掉就好了。目前还没看出其他问题。

## 2018.11.7

实现了场景描述脚本，不用每次改场景都要改代码了，爽到！

## 2018.11.8

I wrote this record at 04:12 on my ubuntu VM. Fuck `std::wifstream`!

现在切回Windows了，吐槽一下，我跑一个小场景，编译器优化全往运行速度上开，MSVC用六个线程，耗时5-7秒；clang++在只占四个硬件线程的虚拟机上跑，只需要3秒……这效率我有点看不懂，明天再测试一波。

## 2018.11.10

昨天一天都在车上，没空写代码；今天把RendererManager和SubareaRendererManager补全了，现在就差Independent Scene Object Definition了，有了这个就能用脚本描述Scene中包括Participating Medium在内的一切元素。

为personal homepage添加了一个atrc-gallery页面。

## 2018.11.11

如计划所述，允许在脚本中引用之前定义的场景元素，目前已经可以用脚本描述任何可以渲染的情景了，立刻画了个琥珀材质的雕塑，想拿来当头像又觉得太丑 Orz

接下来做什么还没完全想好，先画个丁达尔效应吧，然后做BSSRDF或者BDPT。

## 2018.11.17

连续划了好几天的水，一直看不懂BDPT，真是太丢人了……网上很多博客完全没用，这些人以为自己懂了其实他们连unbiased都证明不来。目前只能零零星星看各种thesis和paper。

## 2018.11.19

昨天一天都在赶路，今天基本都在办手续，啥都没做。不过搞清楚了一点：$\delta$从一个定义域经过变量代换变换到另一个定义域时是需要放缩的，而这并不是什么定理，而是为了让它的性质足够良好而作出的定义。我以前在《信号与系统》中怕是学了个假$\delta$函数——我竟然不知道这一点！就是这个性质让我好几天没法理解为什么我推出来的理想透视摄像机的和其他文献中的都不一样……

划水写了个AO Integrator，不过好歹可以作为毕设的一部分。